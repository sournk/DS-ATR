# DS-ATR
Советник для MetaTrader 5. Торгует внутри диапазонов ATR с несколькими видами усреднений.

https://drive.google.com/file/d/1oFk805BNTu3dasW9RlipICPE6tiRAuJ9/view?t=7

## Как это работает?

- Открытие позы при пересечении (не касании) уровня зоны (EUGGBP 2024.05.22).
- TP первой позиции сетки определяется как % расстояния между зонами (задается в `Percent_take_*`).
- Далее TP трейлится на величину движения зоны TP.
- Если активируется зона следующего ТФ, то все вышеперечисленное выполняется заново.
- Если расстояние между средней ценой сетки и TP становится меньше `Min_distance`, то сетка усредняется. 

## Недостатки

### 01. Закрытие сетки по рынку, если TP становится хуже текущей цены

**Проблема:** Оригинальный бот закрывает сетку принудительно, если TP сдвигается ниже текущей цены.

**Решение:** В таком случае оставлять TP неизменным и ждать закрытия по нему или его смещения ниже, когда цена вернется к такому уровню.


### 02. Бесконтрольные усреднения

**Проблема:** Когда цена уходит в боковик в диапазоне усреднения [`Min_distance`; `AVG_GRID_SIZE`], то бот начинает постоянно усредняться без ограничений. Это приводит к сеткам с максимальным количество позиций в течение короткого времени (от нескольких минут). См. пример из теста оригинального бота ниже.
![Бесконтрольные усреднения](img/UM001.%20Uncontrolling%20averaging.png)

**Решение:** В бота MT5 добавлен параметр `DK_MinGridStepPnt`. Им можно ограничить открытие следующей позиции в сетке дистанцией от предыдущей позиции. Бот откроет следующую позиции только, если уровни сблизились так, что расстояние от TP до уровня стало меньше `Min_takeP`, и если цена прошла указанное количество пунктов от прошлой открытой позиции.    

### 03. Убыточные сетки из-за коротких TP

Любые варианты расчета лота следующей позиции в сетке, заложенные в оригинальном боте, не покрывают на 100% убытки от предыдущих позиций. Это происходит потому, что лотность увеличивается в любых вариантах статически, а расстояние TP сокращается динамически под текущий ATR. Поэтому иногда лотности всей сетки не хватает (даже при Мартингейле с мультипликатором 2), чтобы покрыть убытки усредненных позиций на таком коротком TP.
![Убыточные стеки](img/UM002.%20Nonprofitable%20grids.png)

## Настройки

- [x] `Type_position`: Тип позиции

- [ ] `Max_spread_buy`: Максимальный спред для BUY
- [ ] `Count_try_buy`: Кол-во проверок спреда для BUY
- [ ] `Check_minute`: Кол-во минут для новой проверки спреда

- [x] `Is_comment`: Вкл\выкл комментирование
- [x] `Type_lot`: Тип ММ
- [x] `Min_distance`: Минимальное расстояние между уровнями для открытия позиции
- [x] `Lot`: Лот
- [x] `Multi`: Мультипликатор лота (мартингейл)
- [x] `Pair_ratio`: Коэффициент парности
- [x] `Min_takeP`: Минимальный тейк профит для срабатывания усреднения
- [x] `DK_MinGridStepPnt`: ==Мин. шаг между позициями, пункт (0-откл.)== [См. подробнее тут](#бесконтрольные-усреднения).
- [x] `Slip`: Проскальзывание
- [x] `Magic`: Магик
- [x] `Max_pos`: Максимальное кол-во сделок в одном направлении

- [ ] `Type_close`: Принудительный стоп лосс
- [ ] `Max_risk`: Максимальная просадка одной стороны в $

- [x] `Percent_take_1`: Размер ТП относительно расстояния ATR 1
- [x] `Count_atrMTF_tf_1`: ТФ 1 Кол-во баров для начального расчета ATR
- [x] `Time_frame`: ТФ 1 для ATR 
- [x] `RepeatSignal`: Брать ли повторный сигнал. ==В MT5 параметр влияет на все ТФ. В MT4 только на ТФ1==.
- [x] `Is_time_frame_2`: Вкл\выкл ТФ 2
- [x] `Percent_take_2`: Размер ТП относительно расстояния ATR 2
- [x] `Count_atrMTF_tf_2`: ТФ 2 Кол-во баров для начального расчета ATR
- [x] `Time_frame_2`: ТФ 2 для ATR 
- [x] `Is_time_frame_3`: Вкл\выкл ТФ 3
- [x] `Percent_take_3`: Размер ТП относительно расстояния ATR 3
- [x] `Count_atrMTF_tf_3`: ТФ 3 Кол-во баров для начального расчета ATR
- [x] `Time_frame_3`: ТФ 3 для ATR 
- [x] `Show_visual`: Отображать графику
- [x] `Support_color_1`: Цвет прямоугольника поддержки ТФ 1
- [x] `Resistance_color_1`: Цвет прямоугольника поддержки ТФ 1
- [x] `Support_color_2`: Цвет прямоугольника поддержки ТФ 2
- [x] `Resistance_color_2`: Цвет прямоугольника поддержки ТФ 2
- [x] `Support_color_3`: Цвет прямоугольника поддержки ТФ 3
- [x] `Resistance_color_3`: Цвет прямоугольника поддержки ТФ 3
- [x] `Sup_res_fill`: Заливка
- [x] `Sup_res_width`: Толщина границ прямоугольника
- [x] `Sup_res_style`: Стиль границ прямоугольника
- [x] `CommentBot`: Комментарий к позициям
- [x] `11`.LL: Log Level

### Основные фичи
- [x] Закрыть, если TP хуже.
- [x] Толщина уровней = /10?
- [x] При закрытии по TP=уровню НЕ ОТКРЫВАТЬ обратную позу
- [x] При касании след. ТФ TP переключается на него
- [ ] После активации 2-го или 3-го ТФ отключается повторный вход от ТФ1.
- [ ] После активации ТФ3 отключается любые входы до появления нового уровня.

### Доп. фичи
- [ ] Залипание после открытие сдекли. OnTrade?
- [ ] Не закрывать сетку по рынку, если TP после обновления зоны стал хуже текущей цены ASK/BID. См. [подробное описание проблемы](#01-закрытие-сетки-по-рынку-если-tp-становится-хуже-текущей-цены).
- [x] TP последней позы сетки отличается от предыдущих. На след. тике синхронизируется. Сетка от 2023.11.23 + 1мес